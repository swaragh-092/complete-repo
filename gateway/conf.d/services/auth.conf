# ============================================================================
# Auth UI (Admin Dashboard)
# ============================================================================

server {
    listen 443 ssl;
    http2 on;

    server_name admin.local.test;

    # Health
    # This is a simple health check endpoint, to check if the server is up or not
    location = /_healthz {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ok"}';
    }

    include /etc/nginx/snippets/error_response.conf;

    # -------------------------
    # Dynamic routed entrypoint
    # -------------------------

    location / {

        # Basic abuse protection
        limit_req zone=req_limit burst=20 nodelay;

        # Only allow common methods
        limit_except GET POST PUT PATCH DELETE HEAD OPTIONS { deny all; }

        include /etc/nginx/snippets/proxy_headers.conf;
        include /etc/nginx/snippets/security_headers.conf;

        set $upstream_auth_ui http://auth-ui:80;
        proxy_pass $upstream_auth_ui;
    }
}

# ============================================================================
# Centralized Login (Account UI)
# ============================================================================
server {
    listen 443 ssl;
    http2 on;

    server_name account.local.test;

    # Health
    # This is a simple health check endpoint, to check if the server is up or not
    location = /_healthz {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ok"}';
    }


    include /etc/nginx/snippets/error_response.conf;

    # -------------------------
    # Static assets (no rate limiting)
    # -------------------------
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        include /etc/nginx/snippets/proxy_headers.conf;
        set $upstream_login http://centralized-login:80;
        proxy_pass $upstream_login;
    }
    
    # -------------------------
    # Dynamic routed entrypoint
    # -------------------------
    location / {

        default_type application/json;

        # Basic abuse protection (increased burst for SPA)
        limit_req zone=req_limit burst=50 nodelay;

        # Only allow common methods
        limit_except GET POST PUT PATCH DELETE HEAD OPTIONS { deny all; }

        include /etc/nginx/snippets/proxy_headers.conf;
        include /etc/nginx/snippets/security_headers.conf;

        set $upstream_login http://centralized-login:80;
        proxy_pass $upstream_login;
    }
}

# ============================================================================
# Auth Service API
# ============================================================================
server {
    listen 443 ssl;
    http2 on;
    
    server_name auth.local.test;

    # Health
    # This is a simple health check endpoint, to check if the server is up or not
    location = /_healthz {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ok"}';
    }


    include /etc/nginx/snippets/error_response.conf;
    
    # -------------------------
    # Dynamic routed entrypoint
    # -------------------------
    location / {

        default_type application/json;

        # Basic abuse protection
        limit_req zone=req_limit burst=20 nodelay;

        # Only allow common methods
        limit_except GET POST PUT PATCH DELETE HEAD OPTIONS { deny all; }

        include /etc/nginx/snippets/proxy_headers.conf;
        include /etc/nginx/snippets/security_headers.conf;

        set $upstream_auth http://auth-service:4000;
        proxy_pass $upstream_auth;
    }
}  

  # ============================================================================
  # pms-local-v1
  # ============================================================================
  server {
    listen 443 ssl;
    server_name pms-local-v1.local.test;

    location / {
      set $upstream_pms_local_v1 http://pms-local-v1:80;
      proxy_pass $upstream_pms_local_v1;
    }
  }