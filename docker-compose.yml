# ══════════════════════════════════════════════════════════════════════════════
# SSO Stack - Production Docker Compose (Hybrid Mode)
# ══════════════════════════════════════════════════════════════════════════════
# Enterprise-grade configuration with:
# - Separate databases for Auth Service
# - External Keycloak integration (via auth-network)
# - No hardcoded secrets (all via environment variables)
# - Health checks on all services
# ══════════════════════════════════════════════════════════════════════════════

services:

  # ─────────────────────────────────────────────────────────────────────────────
  # Gateway (Nginx Reverse Proxy)
  # ─────────────────────────────────────────────────────────────────────────────
  gateway:
    build:
      context: ./gateway
    container_name: gateway
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    networks:
      - auth-network
    depends_on:
      auth-service:
        condition: service_healthy
      postgres-auth:
        condition: service_healthy
      db-pms:
        condition: service_healthy
      redis:
        condition: service_healthy
      pms:
        condition: service_healthy
      super-administrator:
        condition: service_healthy

  # ════════════════════════════════════════════════════════════════════════════
  # DATABASES
  # ════════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL for Auth Service
  # ─────────────────────────────────────────────────────────────────────────────
  postgres-auth:
    image: postgres:15-alpine
    container_name: sso-postgres-auth
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${AUTH_DB_NAME:-authzotion_db}
      POSTGRES_USER: ${AUTH_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:?AUTH_DB_PASSWORD is required}
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
      - ./auth-service/infrastructure/init-auth-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${AUTH_DB_USER:-postgres} -d ${AUTH_DB_NAME:-authzotion_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL for pms
  # ─────────────────────────────────────────────────────────────────────────────
  db-pms:
    image: postgres:16
    container_name: db-pms
    restart: unless-stopped
    ports:
      - "5411:5432"
    environment:
      POSTGRES_USER: ${PMS_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${PMS_DB_PASSWORD:-1234}
    volumes:
      - postgres-pms-data:/var/lib/postgresql/data
      - ./init-multiple-db.sql:/docker-entrypoint-initdb.d/init-multiple-db.sql
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PMS_DB_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL for Email Service (Dedicated)
  # ─────────────────────────────────────────────────────────────────────────────
  db-email:
    image: postgres:16
    container_name: db-email
    restart: unless-stopped
    environment:
      POSTGRES_DB: email_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${EMAIL_DB_PASSWORD:-1234}
    volumes:
      - postgres-email-data:/var/lib/postgresql/data
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  email-service:
    build:
      context: ./email-service
    container_name: email-service
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 4011

      # SMTP
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      FROM_EMAIL: ${FROM_EMAIL:-noreply@example.com}

      # Database (dedicated)
      DB_HOST: db-email
      DB_PORT: 5432
      DB_NAME: email_service
      DB_USER: postgres
      DB_PASSWORD: ${EMAIL_DB_PASSWORD:-1234}

      # Redis (internal service name)
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Queue
      QUEUE_MAX_ATTEMPTS: 3

      # Security
      SERVICE_SECRET: ${SERVICE_SECRET:?SERVICE_SECRET is required}
    ports:
      - "${EMAIL_SERVICE_PORT:-4011}:4011"
    depends_on:
      db-email:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:4011/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL for super-adminostrator
  # ─────────────────────────────────────────────────────────────────────────────
  db-super-admin:
    image: postgres:16
    container_name: db-super-admin
    restart: unless-stopped
    ports:
      - "5412:5432"
    environment:
      POSTGRES_USER: ${PMS_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${PMS_DB_PASSWORD:-1234}
    volumes:
      - postgres-super-admin-data:/var/lib/postgresql/data
      - ./init-multiple-db.sql:/docker-entrypoint-initdb.d/init-multiple-db.sql
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${PMS_DB_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ... (skipping unchanged parts) ...


  # ─────────────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # ════════════════════════════════════════════════════════════════════════════
  # BACKEND SERVICES
  # ════════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # Auth Service (Node.js API)
  # ─────────────────────────────────────────────────────────────────────────────
  auth-service:
    build:
      context: ./auth-service
      dockerfile: infrastructure/Dockerfile
    container_name: sso-auth-service
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 4000
      # Allow self-signed certs for internal HTTPS calls to Keycloak
      NODE_TLS_REJECT_UNAUTHORIZED: "0"

      # Database
      DB_HOST: postgres-auth
      DB_PORT: 5432
      DB_NAME: ${AUTH_DB_NAME:-authzotion_db}
      DB_USER: ${AUTH_DB_USER:-postgres}
      DB_PASSWORD: ${AUTH_DB_PASSWORD:?AUTH_DB_PASSWORD is required}

      # Keycloak
      # Internal Docker URL (container to container)
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://keycloak:8080}
      # External Browser URL (browser to keycloak)
      FRONTEND_AUTH_URL: ${FRONTEND_AUTH_URL:-https://keycloak.local.test:8443}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-my-projects}
      KEYCLOAK_REALM_ID: ${KEYCLOAK_REALM_ID:-}
      KEYCLOAK_ACCOUNT_UI_CLIENT_SECRET: ${KEYCLOAK_ACCOUNT_UI_CLIENT_SECRET:-}

      # URLs
      # URLs
      FRONTEND_URL: ${FRONTEND_URL:-https://admin.local.test}
      ACCOUNT_UI_URL: ${ACCOUNT_UI_URL:-https://client.local.test}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-https://auth.local.test}

      # Session
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required}
      SESSION_COOKIE_NAME: ${SESSION_COOKIE_NAME:-auth.sid}
      SESSION_COOKIE_DOMAIN: ${SESSION_COOKIE_DOMAIN:-.local.test}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-true}
      SESSION_COOKIE_SAMESITE: ${SESSION_COOKIE_SAMESITE:-none}

      # Refresh Token
      # Refresh Token
      REFRESH_COOKIE_DOMAIN: ${REFRESH_COOKIE_DOMAIN:-.local.test}
      REFRESH_COOKIE_SECURE: ${REFRESH_COOKIE_SECURE:-true}
      REFRESH_COOKIE_SAMESITE: ${REFRESH_COOKIE_SAMESITE:-none}
      REFRESH_COOKIE_MAX_AGE: ${REFRESH_COOKIE_MAX_AGE:-2592000}

      # CORS & Proxy
      TRUST_PROXY: ${TRUST_PROXY:-true}
      CORS_FALLBACK_ORIGINS: ${CORS_FALLBACK_ORIGINS:-}

      # SMTP
      # SMTP_HOST: ${SMTP_HOST:-}
      # SMTP_PORT: ${SMTP_PORT:-587}
      # SMTP_USER: ${SMTP_USER:-}
      # SMTP_PASS: ${SMTP_PASS:-}
      # FROM_EMAIL: ${FROM_EMAIL:-noreply@example.com}

      # Email Service (Microservice)
      EMAIL_SERVICE_URL: http://email-service:4011
      SERVICE_SECRET: ${SERVICE_SECRET:?SERVICE_SECRET is required}

      # Security
      FP_SALT: ${FP_SALT:-}
      DEVICE_TRUST_DURATION_DAYS: ${DEVICE_TRUST_DURATION_DAYS:-30}
      DEVICE_MAX_PER_USER: ${DEVICE_MAX_PER_USER:-10}
      DEVICE_SIMILARITY_THRESHOLD: ${DEVICE_SIMILARITY_THRESHOLD:-85}
    ports:
      - "${AUTH_SERVICE_PORT:-4000}:4000"
    volumes:
      - auth-service-logs:/app/logs
    depends_on:
      postgres-auth:
        condition: service_healthy
      email-service:
        condition: service_healthy
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ════════════════════════════════════════════════════════════════════════════
  # FRONTEND APPLICATIONS
  # ════════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # Auth UI (Admin Dashboard)
  # ─────────────────────────────────────────────────────────────────────────────
  auth-ui:
    build:
      context: ./auth-ui
      dockerfile: infrastructure/Dockerfile
      args:
        VITE_CLIENT_KEY: ${VITE_AUTH_UI_CLIENT_KEY:-admin-ui}
        VITE_AUTH_BASE_URL: ${VITE_AUTH_UI_AUTH_BASE_URL:-https://auth.local.test}
        VITE_API_URL: ${VITE_AUTH_UI_API_URL:-https://auth.local.test}
        VITE_AUTH_URL: ${VITE_AUTH_UI_AUTH_URL:-https://keycloak.local.test:8443}
        VITE_ACCOUNT_UI_URL: ${VITE_LOGIN_ACCOUNT_UI_URL:-https://account.local.test}
        VITE_CALLBACK_URL: ${VITE_AUTH_UI_CALLBACK_URL:-https://admin.local.test/callback}
    container_name: sso-auth-ui
    restart: unless-stopped
    # Ports removed - accessed via Gateway
    # ports:
    #   - "${AUTH_UI_PORT:-5173}:80"
    depends_on:
      auth-service:
        condition: service_healthy
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ─────────────────────────────────────────────────────────────────────────────
  # Centralized Login (User Login Portal)
  # # ─────────────────────────────────────────────────────────────────────────────
  centralized-login:
    build:
      context: ./centralized-login
      dockerfile: infrastructure/Dockerfile
      args:
        VITE_CLIENT_KEY: ${VITE_LOGIN_CLIENT_KEY:-account-ui}
        VITE_AUTH_BASE_URL: ${VITE_LOGIN_AUTH_BASE_URL:-https://auth.local.test}
        VITE_ACCOUNT_UI_URL: ${VITE_LOGIN_ACCOUNT_UI_URL:-https://account.local.test}
        VITE_REDIRECT_URI: ${VITE_LOGIN_REDIRECT_URI:-https://account.local.test/callback}
    container_name: sso-centralized-login
    restart: unless-stopped
    # Ports removed - accessed via Gateway
    # ports:
    #   - "${CENTRALIZED_LOGIN_PORT:-5174}:80"
    depends_on:
      auth-service:
        condition: service_healthy
    networks:
      - auth-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ════════════════════════════════════════════════════════════════════════════
  # PMS & SUPER ADMINISTRATOR SERVICES
  # ════════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # PMS (Project Management System)
  # ─────────────────────────────────────────────────────────────────────────────
  pms:
    build:
      context: ./pms
      dockerfile: Dockerfile
    image: pms/nodejs:latest
    restart: unless-stopped
    container_name: pms
    ports:
      - 3010:3010
    depends_on:
      db-pms:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DB_PREFIX: pms
      DB_HOST: db-pms
      DB_PORT: 5432
      DB_USER: ${PMS_DB_USER:-postgres}
      DB_PASSWORD: ${PMS_DB_PASSWORD:-1234}
      DB_NAME: one
      REDIS_HOST: redis
      REDIS_PORT: 6379
    networks:
      - auth-network
    command: [ "server.js" ]
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ─────────────────────────────────────────────────────────────────────────────
  # Super Administrator
  # ─────────────────────────────────────────────────────────────────────────────
  super-administrator:
    build:
      context: ./super-administrator
      dockerfile: Dockerfile
    image: super_administrator:latest
    container_name: super-administrator
    restart: unless-stopped
    depends_on:
      db-super-admin:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      ENV: ${ENV}
      PORT: 4010

      DB_HOST: db-super-admin
      DB_PORT: 5432
      DB_USER: ${PMS_DB_USER}
      DB_PASSWORD: ${PMS_DB_PASSWORD}
      DB_NAME: super_administrator
      DB_TYPE: postgres
      DB_ZONE: "+05:30"
      DB_PREFIX: ${DB_PREFIX}

      REDIS_HOST: redis
      REDIS_PORT: 6379

      ENC_KEY: ${ENC_KEY}
      ENC_IV: ${ENC_IV}

      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      ACCESS_TOKEN_EXPIRE_TIME: ${ACCESS_TOKEN_EXPIRE_TIME}
      REFRESH_TOKEN_EXPIRE_TIME: ${REFRESH_TOKEN_EXPIRE_TIME}
      RESET_PASSWORD_TOKEN_EXPIRE_TIME: ${RESET_PASSWORD_TOKEN_EXPIRE_TIME}

      GLOBAL: http://localhost:8080/
      APP: http://localhost:8080/
      APP_NAME: nodejs-starter
      LOGO: images/logo.webp
      FRONT_END_DOMAIN: ${FRONT_END_DOMAIN}
    networks:
      - auth-network
    ports:
      - 4010:4010

    command: [ "server.js" ]
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4010/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ══════════════════════════════════════════════════════════════════════════════
networks:
  auth-network:
    name: auth-network
    external: true

# ══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ══════════════════════════════════════════════════════════════════════════════
volumes:
  postgres-auth-data:
    name: sso-postgres-auth-data
  auth-service-logs:
    name: sso-auth-service-logs
  redis-data:
  postgres-pms-data:
    name: sso-postgres-pms-data
  postgres-super-admin-data:
    name: sso-postgres-super-admin-data
  postgres-email-data:
    name: sso-postgres-email-data
